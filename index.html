<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>费用查询</title>
    <style>
    :root{--bg:#0b1220;--card:#111a2b;--fg:#e6eefc;--muted:#98a5c5;--acc:#5aa7ff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:720px;margin:54px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 12px 32px rgba(0,0,0,.35)}
    .hd{padding:22px 22px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:13px;margin-top:6px}
    .row{display:flex;gap:10px;padding:18px 22px;align-items:center;flex-wrap:wrap}
    .input{flex:1 1 260px;display:flex;gap:10px;align-items:center;background:#0b172a;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px}
    input{width:100%;background:transparent;border:0;outline:0;color:var(--fg);font-size:16px}
    button{background:var(--acc);border:0;color:#001026;font-weight:700;border-radius:12px;padding:10px 16px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{padding:0 22px 16px;font-size:12px;color:var(--muted)}
    .result{padding:0 22px 20px}
    .num{font-size:28px;font-weight:800}
    .name{font-weight:700}
    .err{color:#ff8591;font-size:14px}
    .src{padding:0 22px 22px;font-size:12px;color:var(--muted)}
    .src a{color:#9bc5ff}
  </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <div class="hd">
            <h1>费用查询</h1>
            <div class="muted">请输入姓名进行查询，<b>必须与表格中的“姓名”完全一致</b>，将显示对应的金额。</div>
        </div>
        <div class="row">
            <div class="input">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-3.8-3.8" stroke="#98b2e3" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#98b2e3" stroke-width="2"/></svg>
                <input id="nameInput" placeholder="请输入姓名（精确匹配，不能少输或输错）" autocomplete="off" />
            </div>
            <button id="searchBtn">查询</button>
        </div>
        <div id="status" class="status"></div>
        <div class="result">
            <div id="ok" class="muted" style="display:none">查询结果：<span class="name" id="nameOut"></span> 的合计应缴金额为 <span class="num" id="sumOut"></span></div>
            <div id="miss" class="err" style="display:none">未找到该姓名</div>
            <div id="notready" class="muted" style="display:none">数据尚未加载完成</div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
    const CSV_URL = "data.csv";
    const HAS_HEADER = true;
    const $ = (id)=>document.getElementById(id);
    const statusEl = $('status');
    const okEl = $('ok');
    const missEl = $('miss');
    const notReadyEl = $('notready');
    const nameOut = $('nameOut');
    const sumOut = $('sumOut');

    let rows = [];

    function setStatus(t){ statusEl.textContent = t || ''; }

    function norm(s){
      return String(s==null?'' : s)
        .replace(/[\u3000\s]+/g,' ')
        .replace(/[：:]+$/,'')
        .trim();
    }

    function looksLikeSummaryRow(obj){
      const a = norm(obj['序号']);
      const b = norm(obj['姓名']);
      return a === '合计' || a === '总计' || b === '合计' || b === '总计';
    }

    function parseNumber(v){
      const s = String(v==null?'':v).replace(/[,，\s]/g,'');
      const n = Number(s);
      return isFinite(n) ? n : null;
    }

    async function loadCSV(){
      setStatus('正在加载 CSV…');
      try{
        const res = await fetch(CSV_URL, {mode:'cors'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();
        const parsed = Papa.parse(text, { header: HAS_HEADER, skipEmptyLines: true });
        const data = parsed.data || [];
        rows = data.filter(r => r && r['姓名']!=null && r['合计']!=null && !looksLikeSummaryRow(r));
        setStatus(`已加载 ${rows.length} 条记录。`);
      }catch(err){
        setStatus('加载失败：'+ err.message +'。请检查文件格式是否正确”。');
      }
    }

    function searchByNameExact(name){
      const target = norm(name);
      if(!target) return null;
      const rec = rows.find(r => norm(r['姓名']) === target);
      if(!rec) return null;
      const value = parseNumber(rec['合计']);
      return value==null ? String(rec['合计']) : value;
    }

    function showResultFound(name, value){
      okEl.style.display = '';
      missEl.style.display = 'none';
      notReadyEl.style.display = 'none';
      nameOut.textContent = name;
      if(typeof value === 'number'){
        const s = (Math.round(value * 10000) / 10000).toString();
        sumOut.textContent = s;
      }else{
        sumOut.textContent = String(value);
      }
    }

    function showNotFound(){
      okEl.style.display = 'none';
      missEl.style.display = '';
      notReadyEl.style.display = 'none';
    }

    function showNotReady(){
      okEl.style.display = 'none';
      missEl.style.display = 'none';
      notReadyEl.style.display = '';
    }

    function handleSearch(){
      const name = $('nameInput').value;
      if(!rows.length){ showNotReady(); return; }
      if(!name.trim()){ showNotFound(); return; }
      const v = searchByNameExact(name);
      if(v==null){ showNotFound(); }
      else { showResultFound(name, v); }
    }

    $('searchBtn').addEventListener('click', handleSearch);
    $('nameInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSearch(); });

    loadCSV();
  </script>
</body>
</html>
